"use strict";const url=require("url");const HttpRequest=require("../httprequest");const utils=require("../utils/");const abi=require("../abi/");let request;let mcpAccounts;class Contract{constructor(t,e,n){var r=this,o=Array.prototype.slice.call(arguments);if(!t||!Array.isArray(t)){throw new Error("You must provide the json interface of the contract when instantiating a contract object.")}this.options={};this.methods={};var a=o[o.length-1];if(utils.judge(a)==="object"){n=a;this.options=Object.assign(this.options,this._getOrSetDefaultOptions(n));if(utils.judge(e)==="object"){e=null}}this._account=null;this._jsonInterface=[];var s=this.constructor.defaultMci||"latest";Object.defineProperty(this,"defaultMci",{get:function(){return s},set:function(t){if(t){s=t}return s},enumerable:true});Object.defineProperty(this.options,"account",{set:function(t){if(t){r._account=t}return r._account},get:function(){return r._account},enumerable:true});Object.defineProperty(this.options,"jsonInterface",{set:function(t){r.methods={};r._jsonInterface=t.map(function(t){var e,n;t.constant=t.stateMutability==="view"||t.stateMutability==="pure"||t.constant;t.payable=t.stateMutability==="payable"||t.payable;if(t.name){n=utils._jsonInterfaceMethodToString(t)}if(t.type==="function"){t.signature=abi.encodeFunctionSignature(n);e=r._createTxObject&&r._createTxObject.bind({method:t,parent:r});if(!r.methods[t.name]){r.methods[t.name]=e}else{var o=r._createTxObject.bind({method:t,parent:r,nextMethod:r.methods[t.name]});r.methods[t.name]=o}r.methods[t.signature]=e;r.methods[n]=e}else if(t.type==="event"){t.signature=abi.encodeEventSignature(n)}return t});return r._jsonInterface},get:function(){return r._jsonInterface},enumerable:true});this.options.account=e;this.options.jsonInterface=t}clone(){return new this.constructor(this.options.jsonInterface,this.options.account,this.options)}deploy(t){t=t||{};t.arguments=t.arguments||[];t=this._getOrSetDefaultOptions(t);if(!t.data){return utils._fireError(new Error('No "data" specified in neither the given options, nor the default options.'),null,null,null)}var e=this.options.jsonInterface.find(function(t){return t.type==="constructor"})||{};e.signature="constructor";return this._createTxObject.apply({method:e,parent:this,deployData:t.data,_mcpAccounts:this.constructor._mcpAccounts},t.arguments)}_createTxObject(){var t=Array.prototype.slice.call(arguments);var e={tag:"mcp"};e.encodeABI=this.parent._encodeMethodABI.bind(e);e.decodeABI=this.parent._decodeMethodABI.bind(e);e.sendToBlock=this.parent._getRpc.bind(e,"sendToBlock",true);if(this.method.type==="function"){e.call=this.parent._getRpc.bind(e,"call");e.call.request=this.parent._getRpc.bind(e,"call",true)}e.sendBlock=this.parent._getRpc.bind(e,"send");e.sendBlock.request=this.parent._getRpc.bind(e,"send",true);if(t&&this.method.inputs&&t.length!==this.method.inputs.length){if(this.nextMethod){return this.nextMethod.apply(null,t)}throw`
                args_length: ${t.length},
                method_inputs_length: ${this.method.inputs.length},
                method_name: ${this.method.name}
            `}e.arguments=t||[];e._method=this.method;e._parent=this.parent;e._mcpAccounts=this.parent.constructor._mcpAccounts||mcpAccounts;if(this.deployData){e._deployData=this.deployData}return e}_encodeMethodABI(){var e=this._method.signature,n=this.arguments||[];var o=false;var t=this._parent.options.jsonInterface.filter(function(t){return e==="constructor"&&t.type===e||(t.signature===e||t.signature===e.replace("0x","")||t.name===e)&&t.type==="function"}).map(function(t){var e=utils.judge(t.inputs)==="array"?t.inputs.length:0;if(e!==n.length){throw new Error("The number of arguments is not matching the methods required number. You need to pass "+e+" arguments.")}if(t.type==="function"){o=t.signature}return utils.judge(t.inputs)==="array"?t.inputs:[]}).map(function(t){return utils.encode.parse({funArgs:n},{inputs:t}).replace("0x","")})[0]||"";if(e==="constructor"){if(!this._deployData){throw new Error("The contract has no contract data option set. This is necessary to append the constructor parameters.")}return this._deployData+t}else{var r=o?o+t:t;if(!r){throw new Error("Couldn't find a matching contract method named \""+this._method.name+'".')}else{return r}}}_decodeMethodABI(t){if(!t){throw new Error("EncodeData cannot be empty.")}if(Object.prototype.toString.call(t)!=="[object String]"){throw new Error("EncodeData must be of type string.")}t=t.toLowerCase();t=t.replace("0x","");const e=this._method.signature,n=this.arguments||[];let o=false;const r=this._parent.options.jsonInterface.filter(function(t){return e==="constructor"&&t.type===e||(t.signature===e||t.signature===e.replace("0x","")||t.name===e)&&t.type==="function"}).map(function(t){const e=utils.judge(t.inputs)==="array"?t.inputs.length:0;if(e!==n.length){throw new Error("The number of arguments is not matching the methods required number. You need to pass "+e+" arguments.")}if(t.type==="function"){o=t.signature}return utils.judge(t.inputs)==="array"?t:{}});if(r.length!==1){throw new Error("Couldn't find a matching contract method named \""+this._method.name+'".')}const a=r[0];if(Object.keys(a)===0){throw new Error("Couldn't find a matching contract method named \""+this._method.name+'".')}if(e==="constructor"){if(!this._deployData){throw new Error("The contract has no contract data option set. This is necessary to append the constructor parameters.")}t=t.replace(this._deployData.replace("0x",""),"")}else{if(o){o=o.replace("0x","");t=t.replace(o,"")}}const s=utils.decode.parseInputs("0x"+t,a);return s}decodeABI(n){if(!n){throw new Error("EncodeData cannot be empty.")}if(Object.prototype.toString.call(n)!=="[object String]"){throw new Error("EncodeData must be of type string.")}n=n.toLowerCase();n=n.replace("0x","");let o="";let e=false;const t=this.options.jsonInterface.filter(function(t){const e=t.signature&&n.match(t.signature.replace("0x",""));if(e&&t.type==="function"){o=e[0]}return e&&t.type==="function"}).map(function(t){if(t.type==="function"){e=t.signature}return utils.judge(t.inputs)==="array"?t:{}});if(t.length!==1){throw new Error("Couldn't find a matching contract method named.")}const r=t[0];if(Object.keys(r)===0){throw new Error("Couldn't find a matching contract method named.")}if(e){e=e.replace("0x","");n=n.replace(e,"")}const a=utils.decode.parseInputs("0x"+n,r);return{parseData:a,fnInfo:r}}_getOrSetDefaultOptions(t){t.from=(t.from?t.from:null)||this.options.from;t.gas_price=(t.gas_price?String(t.gas_price):null)||this.options.gas_price;t.data=t.data||this.options.data;t.gas=t.gas||this.options.gas;return t}static setProvider(t,e){const n=url.parse(t);const o={host:n.hostname,port:n.port};request=new HttpRequest(o);mcpAccounts=e}async _getRpc(){const s=this;var i=this._parent._setRpcOpt.call(this,Array.prototype.slice.call(arguments));const t=i.options;switch(i.type){case"call":const e={from:t.from||"",to:t.to,data:t.data||"",mci:t.mci||""};const o=await request.call(e);return new Promise(function(t,e){if(o.code===0){const n=s._parent._decodeMethodReturn(s._method.outputs,o.output);s._parent._runCallback(i.callback,null,n);t(n)}else{s._parent._runCallback(i.callback,new Error("Call Error"));e(o)}});case"sendToBlock":const n={from:t.from,to:t.to||"",amount:t.amount,password:t.password,gas:t.gas,gas_price:t.gas_price,data:t.data||"",gen_next_work:t.gen_next_work||"",id:t.id||"",previous:t.previous||""};const r=await request.sendToBlock(n);return r;case"send":const a={from:t.from,to:t.to||"",amount:t.amount,password:t.password,gas:t.gas,gas_price:t.gas_price,data:t.data||"",gen_next_work:t.gen_next_work||"",id:t.id||"",previous:t.previous||""};const c=await request.sendBlock(a);return new Promise(function(n,o){if(c.code!==0){s._parent._runCallback(i.callback,new Error("Send Error"));return o(c)}s._parent._runCallback(i.callback,null,c.hash);let r;let t;let a;const e=async function(){r=await request.getBlockState(c.hash);if(r.code!==0){return o(r)}if(r.block_state.is_stable===0){await a()}const t=await request.getBlock(c.hash);if(t.code!==0){return o(t)}if(r.block_state.is_stable===1){const e=r.block_state;t.block.is_stable=e.is_stable;t.block.stable_content=e.stable_content;t.block.content.level=e.content.level;n(t)}};a=async function(){t=await setTimeout(e,1e3)};a()})}}_setRpcOpt(t,e){var n={};n.type=t.shift();n.callback=this._parent._getCallback(t);if(n.type==="call"&&t[t.length-1]!==true&&(utils.judge(t[t.length-1])==="string"||isFinite(t[t.length-1]))){n.defaultMci=t.pop()}n.options=utils.judge(t[t.length-1])==="object"?t.pop():{};n.options=this._parent._getOrSetDefaultOptions(n.options);n.options.data=this.encodeABI();if(!this._deployData&&!utils.isAccount(this._parent.options.account)){throw new Error("This contract object doesn't have account set yet, please set an account first.")}if(!this._deployData){n.options.to=this._parent.options.account}if(!n.options.data){return utils._fireError(new Error("Couldn't find a matching contract method, or the number of parameters is wrong."),e.eventEmitter,e.reject,n.callback)}return n}_getCallback(t){if(t&&utils.judge(t[t.length-1])==="function"){return t.pop()}}_runCallback(t,e,n){if(utils.judge(t)==="function"){t(e,n)}}_decodeMethodReturn(t,e){if(!e){return null}e=e.indexOf("0x")===-1?"0x"+e:e;var n=abi.decodeParameters(t,e);if(n.__length__===1){return n[0]}else{delete n.__length__;return n}}_decodeEventABI(n,t=this.subOptionsEvent){n.id=n.id||"";n.account=n.account||"";n.data=n.data||"";n.topics=n.topics||[];n.block_hash=n.block_hash||"";var e={};if(t.name==="ALLEVENTS"){t=t.jsonInterface.find(function(t){return t.signature==="0x"+n.topics[0]})||{anonymous:true}}t.inputs=t.inputs||[];if(!t.anonymous){let e=0;t.inputs.forEach(t=>t.indexed?e++:null);if(e>0&&n.topics.length!==e+1){t={anonymous:true,inputs:[]}}}e.id=n.id;e.account=n.account;e.block_hash=n.block_hash;var o=t.anonymous?n.topics:n.topics.slice(1);e.returnValues=abi.decodeLog(t.inputs,n.data,o);delete e.returnValues.__length__;e.event=t.name;e.signature=t.anonymous||!n.topics[0]?null:n.topics[0];e.raw={data:n.data,topics:n.topics};return e}formatOutput(t){var e=this;if(Array.isArray(t)){return t.map(function(t){return e._decodeEventABI(t)})}else{return e._decodeEventABI(t)}}async getPastEvents(t,e){var n=this._generateEventOptions.apply(this,arguments);const o=[];n.params.topics.forEach(t=>{o.push(t.indexOf("0x")===0?t.slice(2):t)});const r={from_stable_block_index:e.from_stable_block_index||0,to_stable_block_index:e.to_stable_block_index,account:n.params.account||"",topics:o||""};const a=await request.logs(r);this.subOptionsEvent=n.event;return this.formatOutput(a.logs)}_generateEventOptions(){var t=Array.prototype.slice.call(arguments);var e=this._getCallback(t);var n=utils.judge(t[t.length-1])==="object"?t.pop():{};var o=utils.judge(t[0])==="string"?t[0]:"allevents";o=o.toLowerCase()==="allevents"?{name:"ALLEVENTS",jsonInterface:this.options.jsonInterface}:this.options.jsonInterface.find(function(t){return t.type==="event"&&(t.name===o||t.signature==="0x"+o.replace("0x",""))});if(!o){throw new Error('Event "'+o.name+"\" doesn't exist in this contract.")}if(!utils.isAccount(this.options.account)){throw new Error("This contract object doesn't have account set yet, please set an account first.")}return{params:this._encodeEventABI(o,n),event:o,callback:e}}_encodeEventABI(t,e){e=e||{};var n=e.filter||{},o={};if(utils.judge(e.topics)==="array"){o.topics=e.topics}else{o.topics=[];if(t&&!t.anonymous&&t.name!=="ALLEVENTS"){o.topics.push(t.signature)}if(t.name!=="ALLEVENTS"){var r=t.inputs.filter(function(t){return t.indexed===true}).map(function(e){var t=n[e.name];if(!t){return null}if(utils.judge(t)==="array"){return t.map(function(t){return abi.encodeParameter(e.type,t)})}return abi.encodeParameter(e.type,t)});o.topics=o.topics.concat(r)}}if(this.options.account){o.account=this.options.account}return o}}module.exports=Contract;