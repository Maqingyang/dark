"use strict";var utils=function(){var e=require("./convert.js");var r=require("./utf8.js");return{defineProperty:require("./properties.js").defineProperty,arrayify:e.arrayify,padZeros:e.padZeros,bigNumberify:require("./bignumber.js").bigNumberify,getAddress:require("./address").getAddress,concat:e.concat,isHexString:e.isHexString,toUtf8Bytes:r.toUtf8Bytes,toUtf8String:r.toUtf8String,hexlify:e.hexlify}}();var errors=require("./errors");var bs58check=require("bs58check");var paramTypeBytes=new RegExp(/^bytes([0-9]*)$/);var paramTypeNumber=new RegExp(/^(u?int)([0-9]*)$/);var paramTypeArray=new RegExp(/^(.*)\[([0-9]*)\]$/);function defaultCoerceFunc(e,r){var t=e.match(paramTypeNumber);if(t&&parseInt(t[2])<=48){return r.toNumber()}return r}function shallowCopy(e){var r={};for(var t in e){r[t]=e[t]}return r}var regexParen=new RegExp("^([^)(]*)\\((.*)\\)([^)(]*)$");var regexIdentifier=new RegExp("^[A-Za-z_][A-Za-z0-9_]*$");function verifyType(e){if(e.match(/^uint($|[^1-9])/)){e="uint256"+e.substring(4)}else if(e.match(/^int($|[^1-9])/)){e="int256"+e.substring(3)}return e}function parseParam(r,e){function t(e){throw new Error('unexpected character "'+r[e]+'" at position '+e+' in "'+r+'"')}var a={type:"",name:"",state:{allowType:true}};var n=a;for(var o=0;o<r.length;o++){var i=r[o];switch(i){case"(":if(!n.state.allowParams){t(o)}delete n.state.allowType;n.type=verifyType(n.type);n.components=[{type:"",name:"",parent:n,state:{allowType:true}}];n=n.components[0];break;case")":delete n.state;n.type=verifyType(n.type);var s=n;n=n.parent;if(!n){t(o)}delete s.parent;delete n.state.allowParams;n.state.allowName=true;n.state.allowArray=true;break;case",":delete n.state;n.type=verifyType(n.type);var u={type:"",name:"",parent:n.parent,state:{allowType:true}};n.parent.components.push(u);delete n.parent;n=u;break;case" ":if(n.state.allowType){if(n.type!==""){n.type=verifyType(n.type);delete n.state.allowType;n.state.allowName=true;n.state.allowParams=true}}if(n.state.allowName){if(n.name!==""){if(e&&n.name==="indexed"){n.indexed=true;n.name=""}else{delete n.state.allowName}}}break;case"[":if(!n.state.allowArray){t(o)}n.type+=i;delete n.state.allowArray;delete n.state.allowName;n.state.readArray=true;break;case"]":if(!n.state.readArray){t(o)}n.type+=i;delete n.state.readArray;n.state.allowArray=true;n.state.allowName=true;break;default:if(n.state.allowType){n.type+=i;n.state.allowParams=true;n.state.allowArray=true}else if(n.state.allowName){n.name+=i;delete n.state.allowArray}else if(n.state.readArray){n.type+=i}else{t(o)}}}if(n.parent){throw new Error("unexpected eof")}delete a.state;a.type=verifyType(a.type);return a}function parseSignatureEvent(e){var r={anonymous:false,inputs:[],type:"event"};var t=e.match(regexParen);if(!t){throw new Error("invalid event: "+e)}r.name=t[1].trim();splitNesting(t[2]).forEach(function(e){e=parseParam(e,true);e.indexed=!!e.indexed;r.inputs.push(e)});t[3].split(" ").forEach(function(e){switch(e){case"anonymous":r.anonymous=true;break;case"":break;default:console.log("unknown modifier: "+e)}});if(r.name&&!r.name.match(regexIdentifier)){throw new Error('invalid identifier: "'+r.name+'"')}return r}function parseSignatureFunction(e){var r={constant:false,inputs:[],outputs:[],payable:false,type:"function"};var t=e.split(" returns ");var a=t[0].match(regexParen);if(!a){throw new Error("invalid signature")}r.name=a[1].trim();if(!r.name.match(regexIdentifier)){throw new Error('invalid identifier: "'+a[1]+'"')}splitNesting(a[2]).forEach(function(e){r.inputs.push(parseParam(e))});a[3].split(" ").forEach(function(e){switch(e){case"constant":r.constant=true;break;case"payable":r.payable=true;break;case"pure":r.constant=true;r.stateMutability="pure";break;case"view":r.constant=true;r.stateMutability="view";break;case"":break;default:console.log("unknown modifier: "+e)}});if(t.length>1){var n=t[1].match(regexParen);if(n[1].trim()!=""||n[3].trim()!=""){throw new Error("unexpected tokens")}splitNesting(n[2]).forEach(function(e){r.outputs.push(parseParam(e))})}return r}function parseSignature(e){if(typeof e==="string"){e=e.replace(/\(/g," (").replace(/\)/g,") ").replace(/\s+/g," ");e=e.trim();if(e.substring(0,6)==="event "){return parseSignatureEvent(e.substring(6).trim())}else{if(e.substring(0,9)==="function "){e=e.substring(9)}return parseSignatureFunction(e.trim())}}throw new Error("unknown fragment")}function coderNull(t){return{name:"null",type:"",encode:function(e){return utils.arrayify([])},decode:function(e,r){if(r>e.length){throw new Error("invalid null")}return{consumed:0,value:t("null",undefined)}},dynamic:false}}var coderNumber=function(n,o,i,s){var u=(i?"int":"uint")+o*8;return{localName:s,name:u,type:u,encode:function(r){try{r=utils.bigNumberify(r)}catch(e){errors.throwError("invalid number value",errors.INVALID_ARGUMENT,{arg:s,type:typeof r,value:r})}r=r.toTwos(o*8).maskn(o*8);if(i){r=r.fromTwos(o*8).toTwos(256)}return utils.padZeros(utils.arrayify(r),32)},decode:function(e,r){if(e.length<r+32){errors.throwError("insufficient data for "+u+" type",errors.INVALID_ARGUMENT,{arg:s,coderType:u,value:utils.hexlify(e.slice(r,r+32))})}var t=32-o;var a=utils.bigNumberify(e.slice(r+t,r+32));if(i){a=a.fromTwos(o*8)}else{a=a.maskn(o*8)}return{consumed:32,value:n(u,a)}}}};var uint256Coder=coderNumber(function(e,r){return r},32,false);function coderBoolean(a,n){return{localName:n,name:"bool",type:"bool",encode:function(e){return uint256Coder.encode(!!e?1:0)},decode:function(e,r){try{var t=uint256Coder.decode(e,r)}catch(e){if(e.reason==="insufficient data for uint256 type"){errors.throwError("insufficient data for boolean type",errors.INVALID_ARGUMENT,{arg:n,coderType:"boolean",value:e.value})}throw e}return{consumed:t.consumed,value:a("boolean",!t.value.isZero())}}}}function coderFixedBytes(t,a,n){var o="bytes"+a;return{localName:n,name:o,type:o,encode:function(r){if(utils.isHexString(r)&&r.length%2!==0){throw new Error("hex string cannot be odd-length")}try{r=utils.arrayify(r);if(r.length>32){throw new Error("too many bytes for field")}}catch(e){errors.throwError("invalid "+o+" value",errors.INVALID_ARGUMENT,{arg:n,type:typeof r,value:e.value})}if(r.length===32){return r}var e=new Uint8Array(32);e.set(r);return e},decode:function(e,r){if(e.length<r+32){errors.throwError("insufficient data for "+o+" type",errors.INVALID_ARGUMENT,{arg:n,coderType:o,value:utils.hexlify(e.slice(r,r+32))})}return{consumed:32,value:t(o,utils.hexlify(e.slice(r,r+a)))}}}}function coderAddress(t,a){return{localName:a,name:"address",type:"address",encode:function(r){try{r=utils.arrayify(utils.getAddress(r))}catch(e){errors.throwError("invalid address",errors.INVALID_ARGUMENT,{arg:a,type:typeof r,value:r})}var e=new Uint8Array(32);e.set(r,12);return e},decode:function(e,r){if(e.length<r+32){errors.throwError("insufficuent data for address type",errors.INVALID_ARGUMENT,{arg:a,coderType:"address",value:utils.hexlify(e.slice(r,r+32))})}return{consumed:32,value:t("address",utils.getAddress(utils.hexlify(e.slice(r,r+32))))}}}}function _encodeDynamicBytes(e){var r=parseInt(32*Math.ceil(e.length/32));var t=new Uint8Array(r-e.length);return utils.concat([uint256Coder.encode(e.length),e,t])}function _decodeDynamicBytes(e,r,t){if(e.length<r+32){errors.throwError("insufficient data for dynamicBytes length",errors.INVALID_ARGUMENT,{arg:t,coderType:"dynamicBytes",value:utils.hexlify(e.slice(r,r+32))})}var a=uint256Coder.decode(e,r).value;try{a=a.toNumber()}catch(e){errors.throwError("dynamic bytes count too large",errors.INVALID_ARGUMENT,{arg:t,coderType:"dynamicBytes",value:a.toString()})}if(e.length<r+32+a){errors.throwError("insufficient data for dynamicBytes type",errors.INVALID_ARGUMENT,{arg:t,coderType:"dynamicBytes",value:utils.hexlify(e.slice(r,r+32+a))})}return{consumed:parseInt(32+32*Math.ceil(a/32)),value:e.slice(r+32,r+32+a)}}function coderDynamicBytes(a,n){return{localName:n,name:"bytes",type:"bytes",encode:function(r){try{r=utils.arrayify(r)}catch(e){errors.throwError("invalid bytes value",errors.INVALID_ARGUMENT,{arg:n,type:typeof r,value:e.value})}return _encodeDynamicBytes(r)},decode:function(e,r){var t=_decodeDynamicBytes(e,r,n);t.value=a("bytes",utils.hexlify(t.value));return t},dynamic:true}}function coderString(a,n){return{localName:n,name:"string",type:"string",encode:function(e){if(typeof e!=="string"){errors.throwError("invalid string value",errors.INVALID_ARGUMENT,{arg:n,type:typeof e,value:e})}return _encodeDynamicBytes(utils.toUtf8Bytes(e))},decode:function(e,r){var t=_decodeDynamicBytes(e,r,n);t.value=a("string",utils.toUtf8String(t.value));return t},dynamic:true}}function alignSize(e){return parseInt(32*Math.ceil(e/32))}function pack(e,a){if(Array.isArray(a)){}else if(a&&typeof a==="object"){var r=[];e.forEach(function(e){r.push(a[e.localName])});a=r}else{errors.throwError("invalid tuple value",errors.INVALID_ARGUMENT,{coderType:"tuple",type:typeof a,value:a})}if(e.length!==a.length){errors.throwError("types/value length mismatch",errors.INVALID_ARGUMENT,{coderType:"tuple",value:a})}a=Array.isArray(a[0])?a[0]:a;var n=[];e.forEach(function(e,r){if(a[r].toString().indexOf("mcp")===0){const t=bs58check.decode(a[r].substr(3)).slice(1);n.push({dynamic:e.dynamic,value:t})}else{n.push({dynamic:e.dynamic,value:e.encode(a[r])})}});var t=0,o=0;n.forEach(function(e,r){if(e.dynamic){t+=32;o+=alignSize(e.value.length)}else{t+=alignSize(e.value.length)}});var i=0,s=t;var u=new Uint8Array(t+o);n.forEach(function(e,r){if(e.dynamic){u.set(uint256Coder.encode(s),i);i+=32;u.set(e.value,s);s+=alignSize(e.value.length)}else{u.set(e.value,i);i+=alignSize(e.value.length)}});return u}function unpack(e,a,n){var o=n;var i=0;var s=[];e.forEach(function(e){let r;if(e.dynamic){var t=uint256Coder.decode(a,n);r=e.decode(a,o+t.value.toNumber());r.consumed=t.consumed}else{r=e.decode(a,n)}if(r.value!=undefined){s.push(r.value)}n+=r.consumed;i+=r.consumed});e.forEach(function(e,r){var t=e.localName;if(!t){return}if(typeof t==="object"){t=t.name}if(!t){return}if(t==="length"){t="_length"}if(s[t]!=null){return}s[t]=s[r]});return{value:s,consumed:i}}function coderArray(c,l,d,f){var y=l.type+"["+(d>=0?d:"")+"]";return{coder:l,localName:f,length:d,name:"array",type:y,encode:function(e){if(!Array.isArray(e)){errors.throwError("expected array value",errors.INVALID_ARGUMENT,{arg:f,coderType:"array",type:typeof e,value:e})}var r=d;var t=new Uint8Array(0);if(r===-1){r=e.length;t=uint256Coder.encode(r)}if(r!==e.length){errors.throwError("array value length mismatch",errors.INVALID_ARGUMENT,{arg:f,coderType:"array",count:e.length,expectedCount:r,value:e})}var a=[];e.forEach(function(e){a.push(l)});return utils.concat([t,pack(a,e)])},decode:function(e,r){var t=0;var a=d;if(a===-1){try{var n=uint256Coder.decode(e,r)}catch(e){errors.throwError("insufficient data for dynamic array length",errors.INVALID_ARGUMENT,{arg:f,coderType:"array",value:e.value})}try{a=n.value.toNumber()}catch(e){errors.throwError("array count too large",errors.INVALID_ARGUMENT,{arg:f,coderType:"array",value:n.value.toString()})}t+=n.consumed;r+=n.consumed}var o={name:l.name,type:l.type,encode:l.encode,decode:l.decode,dynamic:l.dynamic};var i=[];for(var s=0;s<a;s++){i.push(o)}var u=unpack(i,e,r);u.consumed+=t;u.value=c(y,u.value);return u},dynamic:d===-1||l.dynamic}}function coderTuple(a,n,e){var r=false;var t=[];n.forEach(function(e){if(e.dynamic){r=true}t.push(e.type)});var o="tuple("+t.join(",")+")";return{coders:n,localName:e,name:"tuple",type:o,encode:function(e){return pack(n,e)},decode:function(e,r){var t=unpack(n,e,r);t.value=a(o,t.value);return t},dynamic:r}}function splitNesting(e){var r=[];var t="";var a=0;for(var n=0;n<e.length;n++){var o=e[n];if(o===","&&a===0){r.push(t);t=""}else{t+=o;if(o==="("){a++}else if(o===")"){a--;if(a===-1){throw new Error("unbalanced parenthsis")}}}}r.push(t);return r}const paramTypeSimple={address:coderAddress,bool:coderBoolean,string:coderString,bytes:coderDynamicBytes};function getTupleParamCoder(r,e,t){if(!e){e=[]}var a=[];e.forEach(function(e){a.push(getParamCoder(r,e))});return coderTuple(r,a,t)}function getParamCoder(e,r){var t=paramTypeSimple[r.type];if(t){return t(e,r.name)}const a=r.type.match(paramTypeNumber);if(a){const i=parseInt(a[2]||256);if(i===0||i>256||i%8!==0){errors.throwError("invalid "+a[1]+" bit length",errors.INVALID_ARGUMENT,{arg:"param",value:r})}return coderNumber(e,i/8,a[1]==="int",r.name)}const n=r.type.match(paramTypeBytes);if(n){const i=parseInt(n[1]);if(i===0||i>32){errors.throwError("invalid bytes length",errors.INVALID_ARGUMENT,{arg:"param",value:r})}return coderFixedBytes(e,i,r.name)}const o=r.type.match(paramTypeArray);if(o){r=shallowCopy(r);const i=parseInt(o[2]||-1);r.type=o[1];return coderArray(e,getParamCoder(e,r),i,r.name)}if(r.type.substring(0,5)==="tuple"){return getTupleParamCoder(e,r.components,r.name)}if(r.type===""){return coderNull(e)}errors.throwError("invalid type",errors.INVALID_ARGUMENT,{arg:"type",value:r.type})}function Coder(e){if(!(this instanceof Coder)){throw new Error("missing new")}if(!e){e=defaultCoerceFunc}utils.defineProperty(this,"coerceFunc",e)}function populateNames(t,e){if(!e){return}if(t.type.substring(0,5)==="tuple"&&typeof e!=="string"){if(t.components.length!=e.names.length){errors.throwError("names/types length mismatch",errors.INVALID_ARGUMENT,{count:{names:e.names.length,types:t.components.length},value:{names:e.names,types:t.components}})}e.names.forEach(function(e,r){populateNames(t.components[r],e)});e=e.name||""}if(!t.name&&typeof e==="string"){t.name=e}}utils.defineProperty(Coder.prototype,"encode",function(t,e,r){if(arguments.length<3){r=e;e=t;t=[]}if(e.length!==r.length){errors.throwError("types/values length mismatch",errors.INVALID_ARGUMENT,{count:{types:e.length,values:r.length},value:{types:e,values:r}})}var a=[];e.forEach(function(e,r){if(typeof e==="string"){e=parseParam(e)}populateNames(e,t[r]);a.push(getParamCoder(this.coerceFunc,e))},this);return utils.hexlify(coderTuple(this.coerceFunc,a).encode(r))});utils.defineProperty(Coder.prototype,"decode",function(t,e,r){if(arguments.length<3){r=e;e=t;t=[]}r=utils.arrayify(r);var a=[];e.forEach(function(e,r){if(typeof e==="string"){e=parseParam(e)}populateNames(e,t[r]);a.push(getParamCoder(this.coerceFunc,e))},this);return coderTuple(this.coerceFunc,a).decode(r,0).value});utils.defineProperty(Coder,"defaultCoder",new Coder);utils.defineProperty(Coder,"parseSignature",parseSignature);module.exports=Coder;