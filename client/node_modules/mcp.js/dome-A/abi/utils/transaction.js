"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var a in e)if(Object.hasOwnProperty.call(e,a))r[a]=e[a];r["default"]=e;return r};Object.defineProperty(exports,"__esModule",{value:true});var address_1=require("./address");var bignumber_1=require("./bignumber");var bytes_1=require("./bytes");var keccak256_1=require("./keccak256");var RLP=__importStar(require("./rlp"));var errors=__importStar(require("./errors"));function handleAddress(e){if(e==="0x"){return null}return address_1.getAddress(e)}function handleNumber(e){if(e==="0x"){return bignumber_1.ConstantZero}return bignumber_1.bigNumberify(e)}var transactionFields=[{name:"nonce",maxLength:32},{name:"gasPrice",maxLength:32},{name:"gasLimit",maxLength:32},{name:"to",length:20},{name:"value",maxLength:32},{name:"data"}];function serialize(a,e){var n=[];transactionFields.forEach(function(e){var r=a[e.name]||[];r=bytes_1.arrayify(bytes_1.hexlify(r));if(e.length&&r.length!==e.length&&r.length>0){errors.throwError("invalid length for "+e.name,errors.INVALID_ARGUMENT,{arg:"transaction"+e.name,value:r})}if(e.maxLength){r=bytes_1.stripZeros(r);if(r.length>e.maxLength){errors.throwError("invalid length for "+e.name,errors.INVALID_ARGUMENT,{arg:"transaction"+e.name,value:r})}}n.push(bytes_1.hexlify(r))});if(a.chainId!=null&&a.chainId!==0){n.push(bytes_1.hexlify(a.chainId));n.push("0x");n.push("0x")}var r=RLP.encode(n);if(!e){return r}e=bytes_1.splitSignature(e);var i=27+e.recoveryParam;if(n.length===9){n.pop();n.pop();n.pop();i+=a.chainId*2+8}n.push(bytes_1.hexlify(i));n.push(bytes_1.stripZeros(bytes_1.arrayify(e.r)));n.push(bytes_1.stripZeros(bytes_1.arrayify(e.s)));return RLP.encode(n)}exports.serialize=serialize;function parse(e){var r=RLP.decode(e);if(r.length!==9&&r.length!==6){errors.throwError("invalid raw transaction",errors.INVALID_ARGUMENT,{arg:"rawTransactin",value:e})}var a={nonce:handleNumber(r[0]).toNumber(),gasPrice:handleNumber(r[1]),gasLimit:handleNumber(r[2]),to:handleAddress(r[3]),value:handleNumber(r[4]),data:r[5],chainId:0};if(r.length===6){return a}try{a.v=bignumber_1.bigNumberify(r[6]).toNumber()}catch(e){console.log(e);return a}a.r=bytes_1.hexZeroPad(r[7],32);a.s=bytes_1.hexZeroPad(r[8],32);if(bignumber_1.bigNumberify(a.r).isZero()&&bignumber_1.bigNumberify(a.s).isZero()){a.chainId=a.v;a.v=0}else{a.chainId=Math.floor((a.v-35)/2);if(a.chainId<0){a.chainId=0}var n=a.v-27;var i=r.slice(0,6);if(a.chainId!==0){i.push(bytes_1.hexlify(a.chainId));i.push("0x");i.push("0x");n-=a.chainId*2+8}var t=keccak256_1.keccak256(RLP.encode(i));try{a.from=secp256k1_1.recoverAddress(t,{r:bytes_1.hexlify(a.r),s:bytes_1.hexlify(a.s),recoveryParam:n})}catch(e){console.log(e)}a.hash=keccak256_1.keccak256(e)}return a}exports.parse=parse;var secp256k1_1=require("./secp256k1");