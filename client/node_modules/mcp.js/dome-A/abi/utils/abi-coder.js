"use strict";var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)if(Object.prototype.hasOwnProperty.call(r,t))e[t]=r[t]};return function(e,r){a(e,r);function t(){this.constructor=e}e.prototype=r===null?Object.create(r):(t.prototype=r.prototype,new t)}}();var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(e!=null)for(var t in e)if(Object.hasOwnProperty.call(e,t))r[t]=e[t];r["default"]=e;return r};Object.defineProperty(exports,"__esModule",{value:true});var address_1=require("./address");var bignumber_1=require("./bignumber");var bytes_1=require("./bytes");var utf8_1=require("./utf8");var properties_1=require("./properties");var errors=__importStar(require("./errors"));var paramTypeBytes=new RegExp(/^bytes([0-9]*)$/);var paramTypeNumber=new RegExp(/^(u?int)([0-9]*)$/);var paramTypeArray=new RegExp(/^(.*)\[([0-9]*)\]$/);exports.defaultCoerceFunc=function(e,r){var t=e.match(paramTypeNumber);if(t&&parseInt(t[2])<=48){return r.toNumber()}return r};var regexParen=new RegExp("^([^)(]*)\\((.*)\\)([^)(]*)$");var regexIdentifier=new RegExp("^[A-Za-z_][A-Za-z0-9_]*$");function verifyType(e){if(e.match(/^uint($|[^1-9])/)){e="uint256"+e.substring(4)}else if(e.match(/^int($|[^1-9])/)){e="int256"+e.substring(3)}return e}function parseParam(r,e){function t(e){throw new Error('unexpected character "'+r[e]+'" at position '+e+' in "'+r+'"')}var a={type:"",name:"",state:{allowType:true}};var n=a;for(var o=0;o<r.length;o++){var i=r[o];switch(i){case"(":if(!n.state.allowParams){t(o)}n.state.allowType=false;n.type=verifyType(n.type);n.components=[{type:"",name:"",parent:n,state:{allowType:true}}];n=n.components[0];break;case")":delete n.state;if(e&&n.name==="indexed"){n.indexed=true;n.name=""}n.type=verifyType(n.type);var s=n;n=n.parent;if(!n){t(o)}delete s.parent;n.state.allowParams=false;n.state.allowName=true;n.state.allowArray=true;break;case",":delete n.state;if(e&&n.name==="indexed"){n.indexed=true;n.name=""}n.type=verifyType(n.type);var u={type:"",name:"",parent:n.parent,state:{allowType:true}};n.parent.components.push(u);delete n.parent;n=u;break;case" ":if(n.state.allowType){if(n.type!==""){n.type=verifyType(n.type);delete n.state.allowType;n.state.allowName=true;n.state.allowParams=true}}if(n.state.allowName){if(n.name!==""){if(e&&n.name==="indexed"){n.indexed=true;n.name=""}else{n.state.allowName=false}}}break;case"[":if(!n.state.allowArray){t(o)}n.type+=i;n.state.allowArray=false;n.state.allowName=false;n.state.readArray=true;break;case"]":if(!n.state.readArray){t(o)}n.type+=i;n.state.readArray=false;n.state.allowArray=true;n.state.allowName=true;break;default:if(n.state.allowType){n.type+=i;n.state.allowParams=true;n.state.allowArray=true}else if(n.state.allowName){n.name+=i;delete n.state.allowArray}else if(n.state.readArray){n.type+=i}else{t(o)}}}if(n.parent){throw new Error("unexpected eof")}delete a.state;if(e&&n.name==="indexed"){n.indexed=true;n.name=""}a.type=verifyType(a.type);return a}function parseSignatureEvent(e){var r={anonymous:false,inputs:[],name:"",type:"event"};var t=e.match(regexParen);if(!t){throw new Error("invalid event: "+e)}r.name=t[1].trim();splitNesting(t[2]).forEach(function(e){e=parseParam(e,true);e.indexed=!!e.indexed;r.inputs.push(e)});t[3].split(" ").forEach(function(e){switch(e){case"anonymous":r.anonymous=true;break;case"":break;default:console.log("unknown modifier: "+e)}});if(r.name&&!r.name.match(regexIdentifier)){throw new Error('invalid identifier: "'+r.name+'"')}return r}function parseSignatureFunction(e){var r={constant:false,inputs:[],name:"",outputs:[],payable:false,stateMutability:null,type:"function"};var t=e.split(" returns ");var a=t[0].match(regexParen);if(!a){throw new Error("invalid signature")}r.name=a[1].trim();if(!r.name.match(regexIdentifier)){throw new Error('invalid identifier: "'+a[1]+'"')}splitNesting(a[2]).forEach(function(e){r.inputs.push(parseParam(e))});a[3].split(" ").forEach(function(e){switch(e){case"constant":r.constant=true;break;case"payable":r.payable=true;break;case"pure":r.constant=true;r.stateMutability="pure";break;case"view":r.constant=true;r.stateMutability="view";break;case"":break;default:console.log("unknown modifier: "+e)}});if(t.length>1){var n=t[1].match(regexParen);if(n[1].trim()!=""||n[3].trim()!=""){throw new Error("unexpected tokens")}splitNesting(n[2]).forEach(function(e){r.outputs.push(parseParam(e))})}return r}function parseParamType(e){return parseParam(e,true)}exports.parseParamType=parseParamType;function formatParamType(e){return getParamCoder(exports.defaultCoerceFunc,e).type}exports.formatParamType=formatParamType;function formatSignature(e){return e.name+"("+e.inputs.map(function(e){return formatParamType(e)}).join(",")+")"}exports.formatSignature=formatSignature;function parseSignature(e){if(typeof e==="string"){e=e.replace(/\(/g," (").replace(/\)/g,") ").replace(/\s+/g," ");e=e.trim();if(e.substring(0,6)==="event "){return parseSignatureEvent(e.substring(6).trim())}else{if(e.substring(0,9)==="function "){e=e.substring(9)}return parseSignatureFunction(e.trim())}}throw new Error("unknown signature")}exports.parseSignature=parseSignature;var Coder=function(){function e(e,r,t,a,n){this.coerceFunc=e;this.name=r;this.type=t;this.localName=a;this.dynamic=n}return e}();var CoderAnonymous=function(t){__extends(e,t);function e(e){var r=t.call(this,e.coerceFunc,e.name,e.type,undefined,e.dynamic)||this;properties_1.defineReadOnly(r,"coder",e);return r}e.prototype.encode=function(e){return this.coder.encode(e)};e.prototype.decode=function(e,r){return this.coder.decode(e,r)};return e}(Coder);var CoderNull=function(t){__extends(e,t);function e(e,r){return t.call(this,e,"null","",r,false)||this}e.prototype.encode=function(e){return bytes_1.arrayify([])};e.prototype.decode=function(e,r){if(r>e.length){throw new Error("invalid null")}return{consumed:0,value:this.coerceFunc("null",undefined)}};return e}(Coder);var CoderNumber=function(i){__extends(e,i);function e(e,r,t,a){var n=this;var o=(t?"int":"uint")+r*8;n=i.call(this,e,o,o,a,false)||this;n.size=r;n.signed=t;return n}e.prototype.encode=function(r){try{var e=bignumber_1.bigNumberify(r);e=e.toTwos(this.size*8).maskn(this.size*8);if(this.signed){e=e.fromTwos(this.size*8).toTwos(256)}return bytes_1.padZeros(bytes_1.arrayify(e),32)}catch(e){errors.throwError("invalid number value",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:this.name,value:r})}return null};e.prototype.decode=function(e,r){if(e.length<r+32){errors.throwError("insufficient data for "+this.name+" type",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:this.name,value:bytes_1.hexlify(e.slice(r,r+32))})}var t=32-this.size;var a=bignumber_1.bigNumberify(e.slice(r+t,r+32));if(this.signed){a=a.fromTwos(this.size*8)}else{a=a.maskn(this.size*8)}return{consumed:32,value:this.coerceFunc(this.name,a)}};return e}(Coder);var uint256Coder=new CoderNumber(function(e,r){return r},32,false,"none");var CoderBoolean=function(t){__extends(e,t);function e(e,r){return t.call(this,e,"bool","bool",r,false)||this}e.prototype.encode=function(e){return uint256Coder.encode(e?1:0)};e.prototype.decode=function(e,r){try{var t=uint256Coder.decode(e,r)}catch(e){if(e.reason==="insufficient data for uint256 type"){errors.throwError("insufficient data for boolean type",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"boolean",value:e.value})}throw e}return{consumed:t.consumed,value:this.coerceFunc("bool",!t.value.isZero())}};return e}(Coder);var CoderFixedBytes=function(o){__extends(e,o);function e(e,r,t){var a=this;var n="bytes"+r;a=o.call(this,e,n,n,t,false)||this;a.length=r;return a}e.prototype.encode=function(r){var e=new Uint8Array(32);try{var t=bytes_1.arrayify(r);if(t.length>32){throw new Error}e.set(t)}catch(e){errors.throwError("invalid "+this.name+" value",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:this.name,value:e.value||r})}return e};e.prototype.decode=function(e,r){if(e.length<r+32){errors.throwError("insufficient data for "+this.name+" type",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:this.name,value:bytes_1.hexlify(e.slice(r,r+32))})}return{consumed:32,value:this.coerceFunc(this.name,bytes_1.hexlify(e.slice(r,r+this.length)))}};return e}(Coder);var CoderAddress=function(t){__extends(e,t);function e(e,r){return t.call(this,e,"address","address",r,false)||this}e.prototype.encode=function(r){var e=new Uint8Array(33);try{if(r!=="mcp_zero_address"){e.set(bytes_1.arrayify(r))}}catch(e){errors.throwError("invalid address",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"address",value:r})}return e};e.prototype.decode=function(e,r){if(e.length<r+32){errors.throwError("insufficuent data for address type",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"address",value:bytes_1.hexlify(e.slice(r,r+32))})}return{consumed:32,value:this.coerceFunc("address",address_1.getAddress(bytes_1.hexlify(e.slice(r+12,r+32))))}};return e}(Coder);function _encodeDynamicBytes(e){var r=32*Math.ceil(e.length/32);var t=new Uint8Array(r-e.length);return bytes_1.concat([uint256Coder.encode(e.length),e,t])}function _decodeDynamicBytes(e,r,t){if(e.length<r+32){errors.throwError("insufficient data for dynamicBytes length",errors.INVALID_ARGUMENT,{arg:t,coderType:"dynamicBytes",value:bytes_1.hexlify(e.slice(r,r+32))})}var a=uint256Coder.decode(e,r).value;try{a=a.toNumber()}catch(e){errors.throwError("dynamic bytes count too large",errors.INVALID_ARGUMENT,{arg:t,coderType:"dynamicBytes",value:a.toString()})}if(e.length<r+32+a){errors.throwError("insufficient data for dynamicBytes type",errors.INVALID_ARGUMENT,{arg:t,coderType:"dynamicBytes",value:bytes_1.hexlify(e.slice(r,r+32+a))})}return{consumed:32+32*Math.ceil(a/32),value:e.slice(r+32,r+32+a)}}var CoderDynamicBytes=function(t){__extends(e,t);function e(e,r){return t.call(this,e,"bytes","bytes",r,true)||this}e.prototype.encode=function(e){try{return _encodeDynamicBytes(bytes_1.arrayify(e))}catch(e){errors.throwError("invalid bytes value",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"bytes",value:e.value})}return null};e.prototype.decode=function(e,r){var t=_decodeDynamicBytes(e,r,this.localName);t.value=this.coerceFunc("bytes",bytes_1.hexlify(t.value));return t};return e}(Coder);var CoderString=function(t){__extends(e,t);function e(e,r){return t.call(this,e,"string","string",r,true)||this}e.prototype.encode=function(e){if(typeof e!=="string"){errors.throwError("invalid string value",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"string",value:e})}return _encodeDynamicBytes(utf8_1.toUtf8Bytes(e))};e.prototype.decode=function(e,r){var t=_decodeDynamicBytes(e,r,this.localName);t.value=this.coerceFunc("string",utf8_1.toUtf8String(t.value));return t};return e}(Coder);function alignSize(e){return 32*Math.ceil(e/32)}function pack(e,t){if(Array.isArray(t)){}else if(t&&typeof t==="object"){var r=[];e.forEach(function(e){r.push(t[e.localName])});t=r}else{errors.throwError("invalid tuple value",errors.INVALID_ARGUMENT,{coderType:"tuple",value:t})}if(e.length!==t.length){errors.throwError("types/value length mismatch",errors.INVALID_ARGUMENT,{coderType:"tuple",value:t})}var a=[];e.forEach(function(e,r){a.push({dynamic:e.dynamic,value:e.encode(t[r])})});var n=0,o=0;a.forEach(function(e){if(e.dynamic){n+=32;o+=alignSize(e.value.length)}else{n+=alignSize(e.value.length)}});var i=0,s=n;var u=new Uint8Array(n+o);a.forEach(function(e){if(e.dynamic){u.set(uint256Coder.encode(s),i);i+=32;u.set(e.value,s);s+=alignSize(e.value.length)}else{u.set(e.value,i);i+=alignSize(e.value.length)}});return u}function unpack(e,a,n){var o=n;var i=0;var s=[];e.forEach(function(e){let r={};if(e.dynamic){var t=uint256Coder.decode(a,n);r=e.decode(a,o+t.value.toNumber());r.consumed=t.consumed}else{r=e.decode(a,n)}if(r.value!=undefined){s.push(r.value)}n+=r.consumed;i+=r.consumed});e.forEach(function(e,r){var t=e.localName;if(!t){return}if(t==="length"){t="_length"}if(s[t]!=null){return}s[t]=s[r]});return{value:s,consumed:i}}var CoderArray=function(s){__extends(e,s);function e(e,r,t,a){var n=this;var o=r.type+"["+(t>=0?t:"")+"]";var i=t===-1||r.dynamic;n=s.call(this,e,"array",o,a,i)||this;n.coder=r;n.length=t;return n}e.prototype.encode=function(e){if(!Array.isArray(e)){errors.throwError("expected array value",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"array",value:e})}var r=this.length;var t=new Uint8Array(0);if(r===-1){r=e.length;t=uint256Coder.encode(r)}errors.checkArgumentCount(r,e.length,"in coder array"+(this.localName?" "+this.localName:""));var a=[];for(var n=0;n<e.length;n++){a.push(this.coder)}return bytes_1.concat([t,pack(a,e)])};e.prototype.decode=function(e,r){var t=0;var a=this.length;if(a===-1){try{var n=uint256Coder.decode(e,r)}catch(e){errors.throwError("insufficient data for dynamic array length",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"array",value:e.value})}try{a=n.value.toNumber()}catch(e){errors.throwError("array count too large",errors.INVALID_ARGUMENT,{arg:this.localName,coderType:"array",value:n.value.toString()})}t+=n.consumed;r+=n.consumed}var o=[];for(var i=0;i<a;i++){o.push(new CoderAnonymous(this.coder))}var s=unpack(o,e,r);s.consumed+=t;s.value=this.coerceFunc(this.type,s.value);return s};return e}(Coder);var CoderTuple=function(s){__extends(e,s);function e(e,r,t){var a=this;var n=false;var o=[];r.forEach(function(e){if(e.dynamic){n=true}o.push(e.type)});var i="tuple("+o.join(",")+")";a=s.call(this,e,"tuple",i,t,n)||this;a.coders=r;return a}e.prototype.encode=function(e){return pack(this.coders,e)};e.prototype.decode=function(e,r){var t=unpack(this.coders,e,r);t.value=this.coerceFunc(this.type,t.value);return t};return e}(Coder);function splitNesting(e){var r=[];var t="";var a=0;for(var n=0;n<e.length;n++){var o=e[n];if(o===","&&a===0){r.push(t);t=""}else{t+=o;if(o==="("){a++}else if(o===")"){a--;if(a===-1){throw new Error("unbalanced parenthsis")}}}}r.push(t);return r}var paramTypeSimple={address:CoderAddress,bool:CoderBoolean,string:CoderString,bytes:CoderDynamicBytes};function getTupleParamCoder(r,e,t){if(!e){e=[]}var a=[];e.forEach(function(e){a.push(getParamCoder(r,e))});return new CoderTuple(r,a,t)}function getParamCoder(e,r){var t=paramTypeSimple[r.type];if(t){return new t(e,r.name)}const a=r.type.match(paramTypeNumber);if(a){const i=parseInt(a[2]||"256");if(i===0||i>256||i%8!==0){errors.throwError("invalid "+a[1]+" bit length",errors.INVALID_ARGUMENT,{arg:"param",value:r})}return new CoderNumber(e,i/8,a[1]==="int",r.name)}const n=r.type.match(paramTypeBytes);if(n){const i=parseInt(n[1]);if(i===0||i>32){errors.throwError("invalid bytes length",errors.INVALID_ARGUMENT,{arg:"param",value:r})}return new CoderFixedBytes(e,i,r.name)}const o=r.type.match(paramTypeArray);if(o){const i=parseInt(o[2]||"-1");r=properties_1.jsonCopy(r);r.type=o[1];return new CoderArray(e,getParamCoder(e,r),i,r.name)}if(r.type.substring(0,5)==="tuple"){return getTupleParamCoder(e,r.components,r.name)}if(r.type===""){return new CoderNull(e,r.name)}errors.throwError("invalid type",errors.INVALID_ARGUMENT,{arg:"type",value:r.type});return null}var AbiCoder=function(){function r(e){errors.checkNew(this,r);if(!e){e=exports.defaultCoerceFunc}properties_1.defineReadOnly(this,"coerceFunc",e)}r.prototype.encode=function(e,r){if(e.length!==r.length){errors.throwError("types/values length mismatch",errors.INVALID_ARGUMENT,{count:{types:e.length,values:r.length},value:{types:e,values:r}})}var t=[];e.forEach(function(e){var r=null;if(typeof e==="string"){r=parseParam(e)}else{r=e}t.push(getParamCoder(this.coerceFunc,r))},this);return bytes_1.hexlify(new CoderTuple(this.coerceFunc,t,"_").encode(r))};r.prototype.decode=function(e,r){var t=[];e.forEach(function(e){var r=null;if(typeof e==="string"){r=parseParam(e)}else{r=properties_1.jsonCopy(e)}t.push(getParamCoder(this.coerceFunc,r))},this);return new CoderTuple(this.coerceFunc,t,"_").decode(bytes_1.arrayify(r),0).value};return r}();exports.AbiCoder=AbiCoder;exports.defaultAbiCoder=new AbiCoder;