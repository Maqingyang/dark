"use strict";var __importStar=this&&this.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)if(Object.hasOwnProperty.call(r,t))e[t]=r[t];e["default"]=r;return e};Object.defineProperty(exports,"__esModule",{value:true});var xmlhttprequest_1=require("xmlhttprequest");var base64_1=require("./base64");var utf8_1=require("./utf8");var errors=__importStar(require("./errors"));function fetchJson(r,s,u){var t=[];var a=null;if(typeof r==="string"){a=r}else if(typeof r==="object"){if(r.url==null){errors.throwError("missing URL",errors.MISSING_ARGUMENT,{arg:"url"})}a=r.url;if(r.user!=null&&r.password!=null){if(a.substring(0,6)!=="https:"&&r.allowInsecure!==true){errors.throwError("basic authentication requires a secure https url",errors.INVALID_ARGUMENT,{arg:"url",url:a,user:r.user,password:"[REDACTED]"})}var e=r.user+":"+r.password;t.push({key:"Authorization",value:"Basic "+base64_1.encode(utf8_1.toUtf8Bytes(e))})}}return new Promise(function(n,o){var i=new xmlhttprequest_1.XMLHttpRequest;if(s){i.open("POST",a,true);t.push({key:"Content-Type",value:"application/json"})}else{i.open("GET",a,true)}t.forEach(function(r){i.setRequestHeader(r.key,r.value)});i.onreadystatechange=function(){if(i.readyState!==4){return}try{var r=JSON.parse(i.responseText)}catch(t){var e=new Error("invalid json response");e.orginialError=t;e.responseText=i.responseText;e.url=a;o(e);return}if(u){try{r=u(r)}catch(t){t.url=a;t.body=s;t.responseText=i.responseText;o(t);return}}if(i.status!=200){var t=new Error("invalid response - "+i.status);t.statusCode=i.status;o(t);return}n(r)};i.onerror=function(r){o(r)};try{if(s){i.send(s)}else{i.send()}}catch(r){var e=new Error("connection error");e.error=r;o(e)}})}exports.fetchJson=fetchJson;function poll(u,a){if(!a){a={}}if(a.floor==null){a.floor=0}if(a.ceiling==null){a.ceiling=1e4}if(a.interval==null){a.interval=250}return new Promise(function(t,e){var r=null;var n=false;var o=function(){if(n){return false}n=true;if(r){clearTimeout(r)}return true};if(a.timeout){r=setTimeout(function(){if(o()){e(new Error("timeout"))}},a.timeout)}var i=0;function s(){return u().then(function(r){if(r!==undefined){if(o()){t(r)}}else if(a.onceBlock){a.onceBlock.once("block",s)}else if(!n){i++;var e=a.interval*parseInt(String(Math.random()*Math.pow(2,i)));if(e<a.floor){e=a.floor}if(e>a.ceiling){e=a.ceiling}setTimeout(s,e)}return null},function(r){if(o()){e(r)}})}s()})}exports.poll=poll;